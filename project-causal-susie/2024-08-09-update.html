<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exploration P2: an intermediate summary of Causal SuSiE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="2024-08-09-update_files/libs/clipboard/clipboard.min.js"></script>
<script src="2024-08-09-update_files/libs/quarto-html/quarto.js"></script>
<script src="2024-08-09-update_files/libs/quarto-html/popper.min.js"></script>
<script src="2024-08-09-update_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2024-08-09-update_files/libs/quarto-html/anchor.min.js"></script>
<link href="2024-08-09-update_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2024-08-09-update_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2024-08-09-update_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2024-08-09-update_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2024-08-09-update_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exploration P2: an intermediate summary of Causal SuSiE</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Aug 8, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The problem discussed last week is how to include the random error terms when fitting a causal (?) SuSiE model.</p>
<p>Based on the discussion last week, we have two approach to do this:</p>
<section id="approach-1-inflate-the-variance-of-the-random-error" class="level2">
<h2 class="anchored" data-anchor-id="approach-1-inflate-the-variance-of-the-random-error">Approach 1: Inflate the variance of the random error</h2>
<p>In short, we allows the variance of the random error of the generative data model, <span class="math inline">\(\sigma^2\)</span>, to incorporate the effect of the confounding factor on the response. In this case, the estimated variance <span class="math inline">\(\hat{\sigma}^2\)</span> may be inflated because it contains more information.</p>
<p>After estimating the effect size <span class="math inline">\(\{\beta_j\}\)</span> via <span class="math inline">\(L\)</span>-layers of WSERs.</p>
<section id="definition-of-the-simple-weighted-linear-regression" class="level3">
<h3 class="anchored" data-anchor-id="definition-of-the-simple-weighted-linear-regression">Definition of the simple weighted linear regression</h3>
<p>Suppose the (heteroscedastic) simple linear regression is defined as:</p>
<p><span class="math display">\[
Y_i = X_i b + \epsilon_i^*, \text{with } \epsilon_i^{*} \sim N \left(0, \frac{\sigma^2}{w_i}\right)
\]</span></p>
<p>where <span class="math inline">\(w_i = 1/\operatorname{Pr}(X_i = x|U)\)</span>, and for the random errors are mutually independent.</p>
<blockquote class="blockquote">
<p>This (heteroscedastic) simple regression model is equivalent to:</p>
</blockquote>
<p><span class="math display">\[
[w^{1/2} Y] = [w^{1/2} X] b + \epsilon, \ \epsilon \sim N(0, \sigma^2),
\]</span></p>
<blockquote class="blockquote">
<p>which is to reweight the response <span class="math inline">\(Y\)</span> and the predictor <span class="math inline">\(X\)</span> by assinging them weight <span class="math inline">\(w^{1/2}\)</span></p>
</blockquote>
<p>Correspondingly, the MLE of <span class="math inline">\(\beta_1\)</span> and its variance are</p>
<p><span class="math display">\[
\hat{b} := \frac{\sum_{i}w_i x_i y_i}{\sum_i w_i x_i^2}
\]</span></p>
<p><span class="math display">\[
s^2 := \frac{\sigma^2}{\sum_i w_i x_i^2}.
\]</span></p>
<p>The posterior distribution for <span class="math inline">\(b\)</span> is identical up to using notation <span class="math inline">\(\hat{b}\)</span> and <span class="math inline">\(s^2\)</span>:</p>
<p><span class="math display">\[
b|\mathbf{y}, \mathbf{w}, \sigma^2, \sigma_0^2 \sim N_1(\mu_1, \sigma_1^2),
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\sigma_1^2(\mathbf{x}, \mathbf{y}; \sigma^2, \sigma_0^2, \mathbf{w}) := \frac{1}{1/s^2 + 1/\sigma_0^2},
\]</span></p>
<p><span class="math display">\[
\mu_1(\mathbf{x}, \mathbf{y}; \sigma^2, \sigma_0^2, \mathbf{w}) := \frac{\sigma_1^2}{s^2} \cdot \hat{b}.
\]</span></p>
<p>and the Bayes Factor (BF) for comparing this model with the null model <span class="math inline">\((b=0)\)</span> is:</p>
<p><span class="math display">\[
\operatorname{BF}(\mathbf{x}, \mathbf{y}; \sigma^2, \sigma_0^2, \mathbf{w})
:= \sqrt{\frac{s^2}{\sigma_0^2 + s^2}} \exp \left( \frac{z^2}{2} \cdot \frac{\sigma_0^2}{\sigma_0^2 + s^2} \right),
\]</span></p>
<p>where <span class="math inline">\(z := \hat{b}/s\)</span> is the corresponding z-score.</p>
</section>
<section id="the-weighted-single-effect-regression-model-wser" class="level3">
<h3 class="anchored" data-anchor-id="the-weighted-single-effect-regression-model-wser">The weighted single effect regression model (WSER)</h3>
<p>The <strong>definition</strong> of the weighted single effect regression model is, following the notations of the paper, <span class="math display">\[
\mathbf{y} = \mathbf{X}\mathbf{b} + \boldsymbol{\epsilon},
\]</span></p>
<p><span class="math display">\[
\boldsymbol{\epsilon} \sim N_n(0, \sigma^2 W),
\]</span></p>
<p><span class="math display">\[
\mathbf{b} = b \boldsymbol{\gamma},
\]</span></p>
<p><span class="math display">\[
\boldsymbol{\gamma} \sim \operatorname{Multi}(1, \boldsymbol{\pi}),
\]</span></p>
<p><span class="math display">\[
b \sim N_1(0, \sigma_0^2),
\]</span></p>
<p>where <span class="math inline">\(\mathbf{X} \in \mathbb{R}^{n\times p}\)</span>, <span class="math inline">\(W = \operatorname{diag}(1/w_1, \cdots, 1/w_n)\)</span>, <span class="math inline">\(\boldsymbol{\pi} \in (0,1)^p\)</span> is the vector of prior inclusion probabilities.</p>
<p>Using the notations of the summary statistics <span class="math inline">\(\hat{b}\)</span> and <span class="math inline">\(s^2\)</span>, the posterior distribution of the weighted single effect regression is the same as that of the SER (Appendix A2 in Wang et al.(2020)). Moreover, the math formula of layer-wise posterior inclusion probabilities (PIPs), denoted by <span class="math inline">\(\boldsymbol{\alpha} \in (0,1)^p\)</span>, are also identical.</p>
<p><em>Pass</em></p>
</section>
<section id="the-additive-effect-model" class="level3">
<h3 class="anchored" data-anchor-id="the-additive-effect-model">The additive effect model?!?!</h3>
<blockquote class="blockquote">
<p>This section corresponds to Appendix B2: The additive effects model.</p>
</blockquote>
<p>Seems that this variable-wise weighted simple linear regression cannot simply be represented by an additive effects model like</p>
<p><span class="math display">\[
\mathbf{y} = \sum_{l=1}^L \boldsymbol{\mu}_l + \boldsymbol{\epsilon},
\]</span></p>
<p>where <span class="math inline">\(\boldsymbol{\mu}_l = \mathbf{X} \mathbf{b}_l\)</span>.</p>
<blockquote class="blockquote">
<p>Should we use another way to explain the validity of the causal SuSiE model?</p>
</blockquote>
<blockquote class="blockquote">
<p>This step is to validate the iterative Bayesian stepwise selection (IBSS) algorithm is equivalent to the variational approximation.</p>
</blockquote>
<blockquote class="blockquote">
<p>Without the proof in this step, …?</p>
</blockquote>
<blockquote class="blockquote">
<p>We need to show that the IBSS is a kind of optimization step to find the fitted value of the model.</p>
</blockquote>
<blockquote class="blockquote">
<p>Why?!</p>
</blockquote>
<p>Now we assume that the multiple regression model is given by</p>
<p><span class="math display">\[
\mathbf{y} = \mathbf{X}\mathbf{b} + \mathbf{U} \xi + \boldsymbol{\epsilon}, \ \boldsymbol{\epsilon} \sim N_n(0, \sigma^2 I_n).
\]</span></p>
<blockquote class="blockquote">
<p>The linear relationship between <span class="math inline">\(y\)</span> and <span class="math inline">\(U\)</span> is not necessary.</p>
</blockquote>
<p>If this is the case, then everything becomes</p>
</section>
<section id="variational-approximation" class="level3">
<h3 class="anchored" data-anchor-id="variational-approximation">Variational Approximation</h3>
<p>Suppose the prior distribution of <span class="math inline">\(\mathbf{b}\)</span> is <span class="math inline">\(g(\mathbf{b})\)</span>, which, in the empirical Bayes, is to be estimated.</p>
<p>Suppose the variational distribution of <span class="math inline">\(\mathbf{b}\)</span> is <span class="math inline">\(q(\mathbf{b})\)</span>.</p>
<p>Suppose the parameters in the statistical model of data <span class="math inline">\(\mathbf{y}\)</span> given <span class="math inline">\(\mathbf{b}\)</span> are all denoted by <span class="math inline">\(\theta\)</span>, and here <span class="math inline">\(\mathbf{y}\)</span> denotes both the response and the predictors (explanatory variables).</p>
<section id="kl-divergence-and-evidence-of-lower-bound-elbo" class="level4">
<h4 class="anchored" data-anchor-id="kl-divergence-and-evidence-of-lower-bound-elbo">KL-divergence and Evidence of Lower Bound (ELBO)</h4>
<p><span class="math display">\[
\operatorname{KL}(q(\mathbf{b})\| p(\mathbf{b}|\mathbf{y}, \theta))
= \log p(\mathbf{y}) - \mathbb{E}_{q(\mathbf{b})} \left[ \log p(\mathbf{y}|\mathbf{b}, \theta) - \log \frac{g(\mathbf{b})}{q(\mathbf{b})} \right]
\]</span></p>
<p>The second term of the right-hand side is called the evidence of lower bound.</p>
<p>Minimizing the KL-divergence is equivalent to maximizing the ELBO.</p>
<p>To compute the ELBO, we need the prior and variational distributions for the regression coefficients <span class="math inline">\(\mathbf{b}\)</span>, which are already given by model assumptions. Besides, we need the likelihood function of the model, denoted by <span class="math inline">\(p(\mathbf{y}|\mathbf{b}, \theta)\)</span>, or equivalently, the log-likelihood function <span class="math inline">\(\log p(\mathbf{y}|\mathbf{b}, \theta)\)</span>.</p>
<p>It is OK if there is no full form of the (log-)likelihood function, as long as the missing part is independent of <span class="math inline">\(\mathbf{b}\)</span> and is a constant (?).</p>
</section>
</section>
<section id="iterative-bayesian-stepwise-selection" class="level3">
<h3 class="anchored" data-anchor-id="iterative-bayesian-stepwise-selection">Iterative Bayesian Stepwise selection</h3>
<p>The modified iterative Bayesian stepwise selection model is</p>
<p><code>PSEUDOCODE!!</code></p>
<p>Taking <code>Algorithm A3 Iterative Bayesian stepwise selection (extended version)</code> as reference. Lines 2-9 update the ELBO except the terms regarding the residual variance <span class="math inline">\(\sigma^2\)</span>. These includes update the expectation of the the regression coefficients and the PIPs in each layer. Line 10 updates <span class="math inline">\(\sigma^2\)</span> considering the effects of all predictors. Lines 1-10 maximize the ELBO all together.</p>
<p>Consider the generative data model of the causal model given above.<br>
We may apply lines 2-9 similarly to update the regression coefficients and the PIPs, and the only modification is to use <code>WSER</code> instead of the <code>SER</code>. We assume that the causal effect is unbiasedly estimated at this stage. (?!)</p>
<p>In line 10 updating the residual variance <span class="math inline">\(\sigma^2\)</span>, however, we do not account for the effect of confounding factors on the response; instead, those responses are accounted for in the residual variance. This step will, as we suspect, will inflate the estimation of <span class="math inline">\(\sigma^2\)</span>, and the posterior variance of (every single entry of) <span class="math inline">\(\mathbf{b}\)</span>. It will also shrink the Bayes factors.</p>
<p>[Will it shrinks the PIPs as well?]</p>
<section id="update-of-the-residual-variance-sigma2." class="level4">
<h4 class="anchored" data-anchor-id="update-of-the-residual-variance-sigma2.">Update of the residual variance <span class="math inline">\(\sigma^2\)</span>.</h4>
<p>The log-likelihood function is still based on the linear regression model, without considering the confounding effect:</p>
<p><span class="math display">\[
\ell(\mathbf{X}, \mathbf{y}; \mathbf{b}, \sigma^2) = \frac{n}{2} \log (2 \pi \sigma^2) - \frac{1}{2 \sigma^2}\sum_{i=1}^n(y_i - \mathbf{x}_{i.} \mathbf{b})^2
\]</span></p>
<p>where the explanatory variables of the <span class="math inline">\(i\)</span>th individual, <span class="math inline">\(\mathbf{x}_{i.}\)</span>, do not include the confounders.</p>
<p>The residual variance is estimated via the expected residual sum of squares without considering the confounding effect. In this case, the residual variance incorporates the effect of confounders, which in turn may inflate the estimation of the residual variance.</p>
<p>Besides, as the confounding effect in the linear regression model, the intercept terms is essential.</p>
<blockquote class="blockquote">
<p>Try to manually add the all-one column while setting <code>intercept=FALSE</code> in the <code>clamp()</code> function. Compare the fitted results with those setting <code>intercep=TRUE</code> in <code>clamp()</code> and no all-one column.</p>
</blockquote>
</section>
<section id="convergence-condition" class="level4">
<h4 class="anchored" data-anchor-id="convergence-condition">Convergence condition</h4>
<p>We stop updating the regression coefficients when the ELBO converges, i.e., the absolute difference (?) of the ELBOs between the current and previous ones are less than a threshold.</p>
</section>
</section>
<section id="toy-example-1-one-binary-treatment-one-confounder" class="level3">
<h3 class="anchored" data-anchor-id="toy-example-1-one-binary-treatment-one-confounder">Toy example 1: one binary treatment + one confounder</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>expit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x)), <span class="fu">exp</span>(x) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(x)))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><code>2024-07-12-update.qmd</code></p>
</blockquote>
<p>Suppose there are only one confounding factor that affects the (binary) treatments and the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>logit_prob1 <span class="ot">&lt;-</span> <span class="fl">1.2</span><span class="sc">*</span>U <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">expit</span>(logit_prob1))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>logit_prob2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>U <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> <span class="fu">rnorm</span>(n)  </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>X2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">expit</span>(logit_prob2))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">as.matrix</span>(X1), <span class="fu">as.matrix</span>(X2))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">apply</span>(X, <span class="dv">2</span>, as.numeric)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(logit_prob1, logit_prob2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.9296692</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(X1, X2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test with Yates' continuity correction

data:  X1 and X2
X-squared = 25.171, df = 1, p-value = 5.246e-07</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(coefs <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0050260 -0.6163743 -1.3975726</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>esp2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> coefs[<span class="dv">1</span>]<span class="sc">*</span>X1 <span class="sc">+</span> coefs[<span class="dv">2</span>]<span class="sc">*</span>X2 <span class="sc">+</span> coefs[<span class="dv">3</span>]<span class="sc">*</span>U <span class="sc">+</span> esp2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Find the propensity scores and the weight matrix</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>PS1_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(X1 <span class="sc">~</span> U, <span class="at">family =</span> binomial)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>PS1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(PS1_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">expit</span>(logit_prob1), PS1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-08-09-update_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(PS1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01061084 0.98389896</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>PS2_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(X2 <span class="sc">~</span> U, <span class="at">family =</span> binomial)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>PS2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(PS2_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">expit</span>(logit_prob2), PS2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-08-09-update_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(PS2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0472019 0.9570017</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(X1<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>PS1, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>PS1))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(X2<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>PS2, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>PS2))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Wmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(W1, W2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># res_cl1 &lt;- clamp(X, Y, W = Wmat, standardize = F)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(res_cl1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here comes the problem:</p>
<p>This is the code for the modified weighted least squared regression model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>weighted_single_effect_regression <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(y, X,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">W =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">residual_variance =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">prior_inclusion_prob =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">V =</span> <span class="dv">1</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">optimize_V =</span> <span class="fu">c</span>(<span class="st">"none"</span>, <span class="st">"optim"</span>, <span class="st">"EM"</span>, <span class="st">"simple"</span>),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">check_null_threshold =</span> <span class="dv">0</span>) {</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    optimize_V <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(optimize_V)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check W</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(W)) {</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if (is.null(residual_variance))</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   stop("Specify either residual_variance or the initial weight matrix W")</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>      W <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>residual_variance, <span class="at">times =</span> <span class="fu">nrow</span>(X))</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">length</span>(W) <span class="sc">==</span> <span class="fu">nrow</span>(X)) {  <span class="do">## (n by 1) vector</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      W <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(W)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">length</span>(W) <span class="sc">==</span> <span class="fu">nrow</span>(X)<span class="sc">*</span><span class="fu">ncol</span>(X)) {  <span class="do">## (n by p) matrix</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">dim</span>(W)[<span class="dv">1</span>] <span class="sc">!=</span> <span class="fu">nrow</span>(X))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Dimensions of the W do not match!"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Dimensions of the W do not match!"</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check prior_inclusion_probability</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(prior_inclusion_prob)) {</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>      prior_inclusion_prob <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> p, <span class="at">times =</span> p)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(prior_inclusion_prob) <span class="sc">!=</span> p)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"The length of prior inclusion probability does not match"</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale X</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    X_ <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X, <span class="dv">2</span>, <span class="fu">attr</span>(X, <span class="st">"scaled:center"</span>), <span class="st">"-"</span>)  <span class="do">## centralized</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    X_ <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X_, <span class="dv">2</span>, <span class="fu">attr</span>(X, <span class="st">"scaled:scale"</span>), <span class="st">"/"</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the MLE (using scaled X)</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(W) <span class="sc">==</span> <span class="fu">nrow</span>(X)) {  <span class="do">## weight is an (n by 1) vector</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>      XtWX <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">sweep</span>(X_ <span class="sc">*</span> X_, <span class="dv">1</span>, W, <span class="st">"*"</span>))</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>      XtWY <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">sweep</span>(X_, <span class="dv">1</span>, W <span class="sc">*</span> y, <span class="st">"*"</span>))</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {  <span class="do">## weight is an (n by p) matrix</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>      XtWX <span class="ot">&lt;-</span> <span class="fu">colSums</span>(X_ <span class="sc">*</span> X_ <span class="sc">*</span> W)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>      XtWY <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">sweep</span>(X_ <span class="sc">*</span> W, <span class="dv">1</span>, y, <span class="st">"*"</span>))</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># shat2 &lt;- 1 / XtWX</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    shat2 <span class="ot">&lt;-</span> residual_variance <span class="sc">/</span> XtWX  <span class="do">##!!!! </span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    betahat <span class="ot">&lt;-</span> XtWY <span class="sc">/</span> XtWX  <span class="co"># = shat2 * XtWY</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (optimize_V <span class="sc">==</span> <span class="st">"none"</span>) {</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>      V <span class="ot">&lt;-</span> V</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (optimize_V <span class="sc">!=</span> <span class="st">"EM"</span>){  <span class="do">## Does this include residual_variance?</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>      V <span class="ot">&lt;-</span> <span class="fu">optimize_prior_variance</span>(optimize_V, betahat, shat2,</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>                                   prior_inclusion_prob,</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">alpha =</span> <span class="cn">NULL</span>, <span class="at">post_mean2 =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">V_init =</span> V,</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">check_null_threshold =</span> check_null_threshold)</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute log-ABF for each variable</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    zscore2 <span class="ot">&lt;-</span> betahat<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> shat2</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    logBF <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> ((<span class="fu">log</span>(shat2) <span class="sc">-</span> <span class="fu">log</span>(shat2 <span class="sc">+</span> V)) <span class="sc">+</span> zscore2 <span class="sc">*</span> V <span class="sc">/</span> (V <span class="sc">+</span> shat2))</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># deal with special case of infinite shat2</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (e.g. happens if X does not vary)</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    logBF[<span class="fu">is.infinite</span>(shat2)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    maxlogBF <span class="ot">&lt;-</span> <span class="fu">max</span>(logBF)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># w is proportional to ABF, but subtract max for numerical stability</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">exp</span>(logBF <span class="sc">-</span> maxlogBF)  <span class="co"># w = ABF / ABFmax</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the posterior estimates</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Posterior prob for each variable</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    w_weighted <span class="ot">&lt;-</span> w <span class="sc">*</span> prior_inclusion_prob</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> w_weighted <span class="sc">/</span> <span class="fu">sum</span>(w_weighted)</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    post_variance <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span>shat2 <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>V)  <span class="co"># posterior variance</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    post_mean <span class="ot">&lt;-</span> XtWY <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span>shat2 <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>V)   <span class="co"># posterior mean</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    post_mean2 <span class="ot">&lt;-</span> post_variance <span class="sc">+</span> post_mean<span class="sc">^</span><span class="dv">2</span>   <span class="co"># second moment</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ABF for WSER model</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    logBF_model <span class="ot">&lt;-</span> maxlogBF <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(w_weighted))</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># = log(sum(ABF x prior_weights))</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (optimize_V <span class="sc">==</span> <span class="st">"EM"</span>) {  <span class="do">## use residual_variance?</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>      V <span class="ot">&lt;-</span> <span class="fu">optimize_prior_variance</span>(optimize_V, betahat, shat2,</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>                                   prior_inclusion_prob,</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>                                   alpha, post_mean2,</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">check_null_threshold =</span> check_null_threshold)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">alpha =</span> alpha,</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>                <span class="at">mu =</span> post_mean,</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>                <span class="at">mu2 =</span> post_mean2,</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>                <span class="at">betahat =</span> betahat,</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>                <span class="at">logBF =</span> logBF,</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>                <span class="at">logBF_model =</span> logBF_model,</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>                <span class="at">V =</span> V</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only difference between the latest one with the previous one is that we replace</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>shat2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> XtWX</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>shat2 <span class="ot">&lt;-</span> residual_variance <span class="sc">/</span> XtWX  <span class="do">##!!!! </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="approach-2-blame-every-unexplained-variations-except-for-the-effect-of-confounders-incorporated-in-the-weights-on-variance" class="level2">
<h2 class="anchored" data-anchor-id="approach-2-blame-every-unexplained-variations-except-for-the-effect-of-confounders-incorporated-in-the-weights-on-variance">Approach 2: Blame every unexplained variations except for the effect of confounders, incorporated in the weights, on variance</h2>
<p>This approach is the one proposed in <code>2024-07-26-update.qmd</code>. It is optional unless Approach 1 doesn’t work.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>